import{s as l,c as E}from"./supabase-BafKp-QD.js";function y(){return new URLSearchParams(window.location.search).get("id")}async function I(e){const{data:t,error:o}=await l.from("anuncios").select(`
      user_id,
      profiles(
          avatar_url,
          username
          )
      `).eq("id",e).single();return o?(console.error("Erro ao buscar perfil do usuário:",o),null):t}async function b(e){try{const{data:{user:t}}=await l.auth.getUser();if(!t)return console.log("Usuário não autenticado"),null;console.log("Buscando proposta com:",{anuncio_id:e,user_id:t.id});const{data:o,error:a}=await l.from("propostas").select("status, created_at, anuncio_id, interessado_id, anunciante_id").eq("anuncio_id",e).or(`interessado_id.eq.${t.id},anunciante_id.eq.${t.id}`).order("created_at",{ascending:!1}).limit(1);if(console.log("Resultado da busca:",{data:o,error:a}),a)return console.error("Erro ao buscar status da proposta:",a),null;if(!o||o.length===0)return console.log("Nenhuma proposta encontrada para este usuário"),null;console.log("Proposta encontrada:",o[0]);const r=o[0];return r.userRole=r.interessado_id===t.id?"interessado":"anunciante",r}catch(t){return console.error("Erro ao buscar proposta:",t),null}}async function v(e){const{data:t,error:o}=await l.from("anuncios").select("id, titulo, autora, paginas, editora, sobre, imagens").eq("id",e).single();return o?(console.error("Erro ao buscar livro:",o),null):t}function h(e,t=null){if(!e||!e.profiles)return;const o=document.getElementById("anunciador-link"),a=o?.querySelector("img"),r=o?.querySelector("p"),n=document.getElementById("proposta-status"),s=e.profiles;if(a)if(s?.avatar_url){const{data:c}=l.storage.from("userProfiles").getPublicUrl(s.avatar_url);a.src=c.publicUrl,a.alt=s?.username||"Avatar do usuário"}else a.src="../../images/default-avatar.png",a.alt="Avatar padrão";if(r&&(r.textContent=s?.username||"Usuário"),o&&(o.href=`/perfil.html?id=${e.user_id}`),n&&t){const c={pendente:(t.userRole==="anunciante","Pendente"),aceita:"Encerrado",recusada:"Encerrada"};n.textContent=c[t.status]||"Status desconhecido",n.className=`status-badge status-${t.status}`,n.style.display="inline-block"}else n&&(n.style.display="none")}function B(e){if(!e)return;const t=document.getElementById("livro-titulo"),o=document.getElementById("livro-autor"),a=document.getElementById("numero-paginas"),r=document.getElementById("livro-editora"),n=document.getElementById("livro-descricao"),s=document.getElementById("livro-imagens");t&&(t.textContent=`${e.titulo}`),n&&(n.textContent=`Descrição: ${e.sobre||"Descrição não disponível"}`),o&&(o.textContent=`Autor: ${e.autora||"Autor não disponível"}`),a&&(a.textContent=`Número de páginas: ${e.paginas||"N/A"}`),r&&(r.textContent=`Editora: ${e.editora||"Editora não disponível"}`),s&&e.imagens&&e.imagens.length>0&&(s.innerHTML="",e.imagens.forEach(c=>{const i=document.createElement("img");i.src=c,i.alt=e.titulo,i.className="livro-img",s.appendChild(i)}))}document.addEventListener("DOMContentLoaded",async()=>{const e=y();if(console.log("ID do anúncio na URL:",e),!e)return;const t=await v(e),o=await I(e),a=await b(e);console.log("Proposta Status final:",a),B(t),h(o,a);const r=document.getElementById("btn-proposta");r&&r.addEventListener("click",()=>{})});const P="https://kqepdklhdblxbslyhzhv.supabase.co",_="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxZXBka2xoZGJseGJzbHloemh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTYzODcsImV4cCI6MjA3NTAzMjM4N30.sW6NYNjItYjGaTc1oC06Id-c5rsYoZcQpXFlbcj-nBI",d=E(P,_);async function w(e){try{const t=e.name.split(".").pop(),a=`public/${`${Math.random()}.${t}`}`,{data:r,error:n}=await d.storage.from("proposta").upload(a,e);if(n)return console.error("Erro ao fazer upload da imagem:",n),null;const{data:{publicUrl:s}}=d.storage.from("proposta").getPublicUrl(a);return s}catch(t){return console.error("Erro ao fazer upload da imagem:",t),null}}async function C(e){try{const{error:t}=await d.from("propostas").insert([e]);return t?(console.error("Erro ao enviar proposta:",t),!1):!0}catch(t){return console.error("Erro ao enviar proposta:",t),!1}}function f(){const e=document.getElementById("proposta-modal"),t=document.getElementById("btn-proposta"),o=document.getElementById("close-modal"),a=document.getElementById("proposta-form");if(!e||!t||!o||!a){console.error("Elementos do modal não encontrados");return}t.addEventListener("click",()=>{e.style.display="flex"}),o.addEventListener("click",()=>{e.style.display="none",a.reset()}),window.addEventListener("click",r=>{r.target===e&&(e.style.display="none",a.reset())}),a.addEventListener("submit",async r=>{r.preventDefault();const n=a.querySelector('button[type="submit"]');n.disabled=!0,n.textContent="Enviando...";try{const{data:{user:s}}=await d.auth.getUser();if(!s){alert("Você precisa estar logado para enviar uma proposta"),n.disabled=!1,n.textContent="Enviar Proposta";return}const i=new URLSearchParams(window.location.search).get("id");if(!i){alert("ID do anúncio não encontrado"),n.disabled=!1,n.textContent="Enviar Proposta";return}const{data:p}=await d.from("anuncios").select("user_id").eq("id",i).single();if(!p){alert("Anúncio não encontrado"),n.disabled=!1,n.textContent="Enviar Proposta";return}const m=document.getElementById("imagem");let u=null;if(m.files&&m.files[0]&&(u=await w(m.files[0]),!u)){alert("Erro ao fazer upload da imagem. Tente novamente."),n.disabled=!1,n.textContent="Enviar Proposta";return}const g={anuncio_id:i,interessado_id:s.id,anunciante_id:p.user_id,mensagem:document.getElementById("mensagem").value,valor_oferecido:parseFloat(document.getElementById("valor_oferecido").value),imagens:u?[u]:void 0};await C(g)?(alert("Proposta enviada com sucesso!"),e.style.display="none",a.reset()):alert("Erro ao enviar proposta. Tente novamente.")}catch(s){console.error("Erro ao processar proposta:",s),alert("Erro ao enviar proposta. Tente novamente.")}finally{n.disabled=!1,n.textContent="Enviar Proposta"}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f();
