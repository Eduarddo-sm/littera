import{s as i,a as d}from"./popup-BbttVVEm.js";/* empty css              */import{v as b}from"./auth-CgpHnlSf.js";function I(){return new URLSearchParams(window.location.search).get("id")}async function h(e){const{data:t,error:o}=await i.from("anuncios").select(`
      user_id,
      profiles(
          avatar_url,
          username
          )
      `).eq("id",e).single();return o?(console.error("Erro ao buscar perfil do usuário:",o),null):t}async function P(e){try{const{data:{user:t}}=await i.auth.getUser();if(!t)return console.log("Usuário não autenticado"),null;const{data:o,error:n}=await i.from("propostas").select("status, created_at, anuncio_id, interessado_id, anunciante_id").eq("anuncio_id",e).or(`interessado_id.eq.${t.id},anunciante_id.eq.${t.id}`).order("created_at",{ascending:!1}).limit(1);if(n)return console.error("Erro ao buscar status da proposta:",n),null;if(!o||o.length===0)return null;const r=o[0];return r.userRole=r.interessado_id===t.id?"interessado":"anunciante",r}catch(t){return console.error("Erro ao buscar proposta:",t),null}}async function B(e){const{data:t,error:o}=await i.from("anuncios").select("id, titulo, autora, paginas, editora, sobre, imagens, status").eq("id",e).single();return o?(console.error("Erro ao buscar livro:",o),null):t}function w(e,t=null){if(!e||!e.profiles)return;const o=document.getElementById("anunciador-link"),n=o?.querySelector("img"),r=o?.querySelector("p"),a=document.getElementById("proposta-status"),s=e.profiles;if(n)if(s?.avatar_url){const{data:u}=i.storage.from("userProfiles").getPublicUrl(s.avatar_url);n.src=u.publicUrl,n.alt=s?.username||"Avatar do usuário"}else n.src="../../images/default-avatar.png",n.alt="Avatar padrão";if(r&&(r.textContent=s?.username||"Usuário"),o&&(o.href=`/pages/loja/perfil.html?id=${e.user_id}`),a&&t){const u={pendente:(t.userRole==="anunciante","Pendente"),aceita:"Encerrado",recusada:"Encerrada"};a.textContent=u[t.status]||"Status desconhecido",a.className=`status-badge status-${t.status}`,a.style.display="inline-block"}else a&&(a.style.display="none")}let l=0,c=0;function x(e){if(!e)return;const t=document.getElementById("livro-titulo"),o=document.getElementById("livro-autor"),n=document.getElementById("numero-paginas"),r=document.getElementById("livro-editora"),a=document.getElementById("livro-descricao"),s=document.getElementById("livro-imagens");t&&(t.textContent=`${e.titulo}`),a&&(a.textContent=`Descrição: ${e.sobre||"Descrição não disponível"}`),o&&(o.textContent=`Autor: ${e.autora||"Autor não disponível"}`),n&&(n.textContent=`Número de páginas: ${e.paginas||"N/A"}`),r&&(r.textContent=`Editora: ${e.editora||"Editora não disponível"}`),s&&e.imagens&&e.imagens.length>0&&(c=e.imagens.length,l=0,y(s,e.imagens,e.titulo),C(s,e.imagens,e.titulo))}function y(e,t,o){if(e.innerHTML="",t.length>0){const n=document.createElement("img");n.src=t[l],n.alt=`${o} - Imagem ${l+1} de ${c}`,n.className="livro-img",e.appendChild(n)}}function C(e,t,o){const n=document.getElementById("btn-prev-img"),r=document.getElementById("btn-next-img");(()=>{n&&(n.style.display=c>1?"block":"none"),r&&(r.style.display=c>1?"block":"none")})(),n&&n.addEventListener("click",()=>{l=(l-1+c)%c,y(e,t,o)}),r&&r.addEventListener("click",()=>{l=(l+1)%c,y(e,t,o)})}document.addEventListener("DOMContentLoaded",async()=>{const e=I();if(!e)return;const t=await B(e),o=await h(e),n=await P(e);x(t),w(o,n);const r=document.getElementById("btn-proposta");r&&t&&t.status==="FECHADO"&&(r.disabled=!0,r.textContent="Anúncio Fechado",r.style.background="#323232",r.style.cursor="not-allowed")});async function _(e){try{const t=e.name.split(".").pop(),n=`public/${`${Math.random()}.${t}`}`,{data:r,error:a}=await i.storage.from("proposta").upload(n,e);if(a)return console.error("Erro ao fazer upload da imagem:",a),null;const{data:{publicUrl:s}}=i.storage.from("proposta").getPublicUrl(n);return s}catch(t){return console.error("Erro ao fazer upload da imagem:",t),null}}async function $(e){try{const{error:t}=await i.from("propostas").insert([e]);return t?(console.error("Erro ao enviar proposta:",t),!1):!0}catch(t){return console.error("Erro ao enviar proposta:",t),!1}}function E(){const e=document.getElementById("proposta-modal"),t=document.getElementById("btn-proposta"),o=document.getElementById("close-modal"),n=document.getElementById("proposta-form");if(!e||!t||!o||!n){console.error("Elementos do modal não encontrados");return}t.addEventListener("click",async()=>{await b()||(e.style.display="none"),e.style.display="flex"}),o.addEventListener("click",()=>{e.style.display="none",n.reset()}),window.addEventListener("click",r=>{r.target===e&&(e.style.display="none",n.reset())}),n.addEventListener("submit",async r=>{r.preventDefault();const a=n.querySelector('button[type="submit"]');a.disabled=!0,a.textContent="Enviando...";try{const{data:{user:s}}=await i.auth.getUser();if(!s){d("Você precisa estar logado para enviar uma proposta",3e3,0),a.disabled=!1,a.textContent="Enviar Proposta";return}const p=new URLSearchParams(window.location.search).get("id");if(!p){d("ID do anúncio não encontrado",3e3,0),a.disabled=!1,a.textContent="Enviar Proposta";return}const{data:f}=await i.from("anuncios").select("user_id, status").eq("id",p).single();if(!f){d("Anúncio não encontrado",3e3,0),a.disabled=!1,a.textContent="Enviar Proposta";return}if(f.status==="FECHADO"){d("Este anúncio já está fechado e não aceita mais propostas.",3e3,0),e.style.display="none",a.disabled=!1,a.textContent="Enviar Proposta";return}const g=document.getElementById("imagem");let m=null;if(g.files&&g.files[0]&&(m=await _(g.files[0]),!m)){d("Erro ao fazer upload da imagem. Tente novamente.",3e3,0),a.disabled=!1,a.textContent="Enviar Proposta";return}const v={anuncio_id:p,interessado_id:s.id,anunciante_id:f.user_id,mensagem:document.getElementById("mensagem").value,valor_oferecido:parseFloat(document.getElementById("valor_oferecido").value),imagens:m?[m]:void 0};await $(v)?(d("Proposta enviada com sucesso!",3e3,1),e.style.display="none",n.reset()):d("Erro ao enviar proposta. Tente novamente.",3e3,0)}catch(s){console.error("Erro ao processar proposta:",s),d("Erro ao enviar proposta. Tente novamente.",3e3,0)}finally{a.disabled=!1,a.textContent="Enviar Proposta"}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",E):E();
