import{s as f,c as E}from"./supabase-BafKp-QD.js";function y(){return new URLSearchParams(window.location.search).get("id")}async function I(e){const{data:t,error:r}=await f.from("anuncios").select(`
      user_id,
      profiles(
          user_profile,
          username
          )
      `).eq("id",e).single();return r?(console.error("Erro ao buscar perfil do usuário:",r),null):t}async function v(e){const{data:t,error:r}=await f.from("anuncios").select("id, titulo, autora, paginas, editora, sobre, imagens").eq("id",e).single();return r?(console.error("Erro ao buscar livro:",r),null):t}function b(e){if(!e||!e.profiles)return;const t=document.getElementById("anunciador-link"),r=t?.querySelector("img"),o=t?.querySelector("p"),a=e.profiles;r&&(r.src=a?.user_profile||""),o&&(o.textContent=a?.username||""),t&&(t.href=`/perfil.html?id=${e.user_id}`)}function h(e){if(!e)return;const t=document.getElementById("livro-titulo"),r=document.getElementById("livro-autor"),o=document.getElementById("numero-paginas"),a=document.getElementById("livro-editora"),n=document.getElementById("livro-descricao"),s=document.getElementById("livro-imagens");t&&(t.textContent=`${e.titulo}`),n&&(n.textContent=`Descrição: ${e.sobre||"Descrição não disponível"}`),r&&(r.textContent=`Autor: ${e.autora||"Autor não disponível"}`),o&&(o.textContent=`Número de páginas: ${e.paginas||"N/A"}`),a&&(a.textContent=`Editora: ${e.editora||"Editora não disponível"}`),s&&e.imagens&&e.imagens.length>0&&(s.innerHTML="",e.imagens.forEach(u=>{const i=document.createElement("img");i.src=u,i.alt=e.titulo,i.className="livro-img",s.appendChild(i)}))}document.addEventListener("DOMContentLoaded",async()=>{const e=y();if(!e)return;const t=await v(e),r=await I(e);h(t),b(r);const o=document.getElementById("btn-proposta");o&&o.addEventListener("click",()=>{})});const B="https://kqepdklhdblxbslyhzhv.supabase.co",C="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxZXBka2xoZGJseGJzbHloemh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTYzODcsImV4cCI6MjA3NTAzMjM4N30.sW6NYNjItYjGaTc1oC06Id-c5rsYoZcQpXFlbcj-nBI",c=E(B,C);async function w(e){try{const t=e.name.split(".").pop(),o=`public/${`${Math.random()}.${t}`}`,{data:a,error:n}=await c.storage.from("proposta").upload(o,e);if(n)return console.error("Erro ao fazer upload da imagem:",n),null;const{data:{publicUrl:s}}=c.storage.from("proposta").getPublicUrl(o);return s}catch(t){return console.error("Erro ao fazer upload da imagem:",t),null}}async function P(e){try{const{error:t}=await c.from("propostas").insert([e]);return t?(console.error("Erro ao enviar proposta:",t),!1):!0}catch(t){return console.error("Erro ao enviar proposta:",t),!1}}function p(){const e=document.getElementById("proposta-modal"),t=document.getElementById("btn-proposta"),r=document.getElementById("close-modal"),o=document.getElementById("proposta-form");if(!e||!t||!r||!o){console.error("Elementos do modal não encontrados");return}t.addEventListener("click",()=>{e.style.display="flex"}),r.addEventListener("click",()=>{e.style.display="none",o.reset()}),window.addEventListener("click",a=>{a.target===e&&(e.style.display="none",o.reset())}),o.addEventListener("submit",async a=>{a.preventDefault();const n=o.querySelector('button[type="submit"]');n.disabled=!0,n.textContent="Enviando...";try{const{data:{user:s}}=await c.auth.getUser();if(!s){alert("Você precisa estar logado para enviar uma proposta"),n.disabled=!1,n.textContent="Enviar Proposta";return}const i=new URLSearchParams(window.location.search).get("id");if(!i){alert("ID do anúncio não encontrado"),n.disabled=!1,n.textContent="Enviar Proposta";return}const{data:m}=await c.from("anuncios").select("user_id").eq("id",i).single();if(!m){alert("Anúncio não encontrado"),n.disabled=!1,n.textContent="Enviar Proposta";return}const d=document.getElementById("imagem");let l=null;if(d.files&&d.files[0]&&(l=await w(d.files[0]),!l)){alert("Erro ao fazer upload da imagem. Tente novamente."),n.disabled=!1,n.textContent="Enviar Proposta";return}const g={anuncio_id:i,interessado_id:s.id,anunciante_id:m.user_id,mensagem:document.getElementById("mensagem").value,valor_oferecido:parseFloat(document.getElementById("valor_oferecido").value),imagens:l?[l]:void 0};await P(g)?(alert("Proposta enviada com sucesso!"),e.style.display="none",o.reset()):alert("Erro ao enviar proposta. Tente novamente.")}catch(s){console.error("Erro ao processar proposta:",s),alert("Erro ao enviar proposta. Tente novamente.")}finally{n.disabled=!1,n.textContent="Enviar Proposta"}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",p):p();
