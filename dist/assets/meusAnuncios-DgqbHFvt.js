import{s as m}from"./supabase-BafKp-QD.js";const E=document.getElementById("form-cadastrar-livro");let u=[];function p(){const e=document.getElementById("image-preview");e&&(e.innerHTML="",u.forEach((n,t)=>{const a=new FileReader;a.onload=s=>{const o=document.createElement("div");o.className="image-preview-item";const i=document.createElement("img");i.src=s.target?.result;const c=document.createElement("button");c.className="image-preview-remove",c.innerHTML="×",c.type="button",c.onclick=()=>{u.splice(t,1),p(),b()},o.appendChild(i),o.appendChild(c),e.appendChild(o)},a.readAsDataURL(n)}))}function b(){const e=document.getElementById("imagem");if(!e)return;const n=new DataTransfer;u.forEach(t=>n.items.add(t)),e.files=n.files}async function L(e){const n=[];for(let t=0;t<Math.min(e.length,5);t++){const a=e[t],s=a.name.split(".").pop(),o=`public/${Date.now()}-${Math.random().toString(36).substring(2,8)}.${s}`,{data:i,error:c}=await m.storage.from("livros").upload(o,a);if(c)throw c;const{data:r}=m.storage.from("livros").getPublicUrl(o);n.push(r.publicUrl)}return n}if(E){const e=document.getElementById("imagem");e&&e.addEventListener("change",n=>{const t=n.target.files;if(t){if(t.length>5){alert("Você pode selecionar no máximo 5 imagens."),e.value="",u=[],p();return}u=Array.from(t),p()}}),E.addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("titulo").value,a=document.getElementById("autora").value,s=parseInt(document.getElementById("paginas").value,10),o=document.getElementById("editora").value,i=document.getElementById("sobre").value,r=document.getElementById("imagem").files;if(!r||r.length===0){alert("Selecione pelo menos uma imagem.");return}if(r.length>5){alert("Você pode enviar no máximo 5 imagens.");return}try{const{data:d,error:l}=await m.auth.getUser();if(l||!d?.user){alert("Usuário não autenticado."),console.error("Erro de autenticação:",l);return}const _=d.user.id;let h=[];try{h=await L(r)}catch(y){alert("Erro ao fazer upload das imagens: "+y.message),console.error("Erro upload imagens:",y);return}const{data:I,error:f}=await m.from("anuncios").insert([{user_id:_,titulo:t,autora:a,paginas:s,editora:o,sobre:i,imagens:h}]);if(f){alert("Erro ao inserir no banco: "+f.message),console.error("Erro insert:",f);return}console.log("Insert data:",I),alert("Livro cadastrado com sucesso!"),E.reset(),u=[],p()}catch(d){alert("Erro inesperado ao cadastrar livro: "+d.message),console.error("Erro inesperado:",d)}})}async function w(){try{const{data:{user:e}}=await m.auth.getUser();if(!e)return console.error("Usuário não autenticado"),[];const{data:n,error:t}=await m.from("propostas").select(`
        id,
        anuncio_id,
        interessado_id,
        anunciante_id,
        mensagem,
        valor_oferecido,
        imagens,
        status,
        created_at,
        anuncios:anuncio_id (titulo),
        profiles:interessado_id (username, name)
      `).eq("anunciante_id",e.id).order("created_at",{ascending:!1});return t?(console.error("Erro ao buscar propostas:",t),[]):(n||[]).map(a=>({id:a.id,anuncio_id:a.anuncio_id,interessado_id:a.interessado_id,anunciante_id:a.anunciante_id,mensagem:a.mensagem,valor_oferecido:a.valor_oferecido,imagens:a.imagens,status:a.status,created_at:a.created_at,anuncio_titulo:a.anuncios?.titulo||"Anúncio não encontrado",interessado_username:a.profiles?.username||a.profiles?.name||"Usuário desconhecido"}))}catch(e){return console.error("Erro inesperado ao buscar propostas:",e),[]}}function N(e){const n=document.createElement("div");n.className=`proposta-card ${e.status}`;const t=document.createElement("div");t.className="proposta-header";const a=document.createElement("div");a.className="proposta-titulo",a.textContent=e.anuncio_titulo||"Sem título";const s=document.createElement("span");s.className=`proposta-status ${e.status}`,s.textContent=e.status,t.appendChild(a),t.appendChild(s);const o=document.createElement("div");o.className="proposta-info",o.textContent=`De: ${e.interessado_username}`;const i=document.createElement("div");return i.className="proposta-valor",i.textContent=e.valor_oferecido?`R$ ${e.valor_oferecido.toFixed(2)}`:"Sem valor definido",n.appendChild(t),n.appendChild(o),n.appendChild(i),n.addEventListener("click",()=>B(e)),n}function B(e){const n=document.getElementById("proposta-modal"),t=document.getElementById("modal-body");if(!n||!t)return;t.innerHTML="";const a=document.createElement("div");a.className="modal-proposta-info",a.innerHTML=`<strong>Anúncio:</strong> ${e.anuncio_titulo}`,t.appendChild(a);const s=document.createElement("div");s.className="modal-proposta-info",s.innerHTML=`<strong>Interessado:</strong> ${e.interessado_username}`,t.appendChild(s);const o=document.createElement("div");o.className="modal-proposta-info",o.innerHTML=`<strong>Valor Oferecido:</strong> ${e.valor_oferecido?`R$ ${e.valor_oferecido.toFixed(2)}`:"Não informado"}`,t.appendChild(o);const i=document.createElement("div");i.className="modal-proposta-info",i.innerHTML=`<strong>Mensagem:</strong><br>${e.mensagem||"Sem mensagem"}`,t.appendChild(i);const c=document.createElement("div");if(c.className="modal-proposta-info",c.innerHTML=`<strong>Status:</strong> <span class="proposta-status ${e.status}">${e.status}</span>`,t.appendChild(c),e.imagens&&e.imagens.length>0){const r=document.createElement("div");r.className="modal-images",e.imagens.forEach(d=>{const l=document.createElement("img");l.src=d,l.alt="Imagem da proposta",r.appendChild(l)}),t.appendChild(r)}if(e.status==="pendente"){const r=document.createElement("div");r.className="modal-actions";const d=document.createElement("button");d.className="btn-aceitar",d.textContent="Aceitar",d.addEventListener("click",async()=>{await C(e.id,"aceita"),g(),v()});const l=document.createElement("button");l.className="btn-recusar",l.textContent="Recusar",l.addEventListener("click",async()=>{await C(e.id,"recusada"),g(),v()}),r.appendChild(d),r.appendChild(l),t.appendChild(r)}n.classList.add("show")}function g(){const e=document.getElementById("proposta-modal");e&&e.classList.remove("show")}async function C(e,n){try{const{error:t}=await m.from("propostas").update({status:n}).eq("id",e);t?(console.error("Erro ao atualizar status:",t),alert("Erro ao atualizar proposta. Tente novamente.")):alert(`Proposta ${n} com sucesso!`)}catch(t){console.error("Erro inesperado:",t),alert("Erro inesperado. Tente novamente.")}}async function v(){const e=await w(),n=document.getElementById("propostas-list");if(n){if(n.innerHTML="",e.length===0){const t=document.createElement("p");t.textContent="Nenhuma proposta recebida.",t.style.textAlign="center",t.style.color="#6b7280",n.appendChild(t);return}e.forEach(t=>{n.appendChild(N(t))})}}document.addEventListener("DOMContentLoaded",()=>{v();const e=document.querySelector(".close-modal");e&&e.addEventListener("click",g);const n=document.getElementById("proposta-modal");n&&n.addEventListener("click",t=>{t.target===n&&g()})});
