import{s as m}from"./supabase-BafKp-QD.js";const E=document.getElementById("form-cadastrar-livro");let u=[];function p(){const e=document.getElementById("image-preview");e&&(e.innerHTML="",u.forEach((n,t)=>{const a=new FileReader;a.onload=i=>{const r=document.createElement("div");r.className="image-preview-item";const c=document.createElement("img");c.src=i.target?.result;const s=document.createElement("button");s.className="image-preview-remove",s.innerHTML="√ó",s.type="button",s.onclick=()=>{u.splice(t,1),p(),w()},r.appendChild(c),r.appendChild(s),e.appendChild(r)},a.readAsDataURL(n)}))}function w(){const e=document.getElementById("imagem");if(!e)return;const n=new DataTransfer;u.forEach(t=>n.items.add(t)),e.files=n.files}async function L(e){const n=[];for(let t=0;t<Math.min(e.length,5);t++){const a=e[t],i=a.name.split(".").pop(),r=`public/${Date.now()}-${Math.random().toString(36).substring(2,8)}.${i}`,{data:c,error:s}=await m.storage.from("livros").upload(r,a);if(s)throw s;const{data:o}=m.storage.from("livros").getPublicUrl(r);n.push(o.publicUrl)}return n}if(E){const e=document.getElementById("imagem");e&&e.addEventListener("change",n=>{const t=n.target.files;if(t){if(t.length>5){alert("Voc√™ pode selecionar no m√°ximo 5 imagens."),e.value="",u=[],p();return}u=Array.from(t),p()}}),E.addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("titulo").value,a=document.getElementById("autora").value,i=parseInt(document.getElementById("paginas").value,10),r=document.getElementById("editora").value,c=document.getElementById("sobre").value,o=document.getElementById("imagem").files;if(!o||o.length===0){alert("Selecione pelo menos uma imagem.");return}if(o.length>5){alert("Voc√™ pode enviar no m√°ximo 5 imagens.");return}try{const{data:d,error:l}=await m.auth.getUser();if(l||!d?.user){alert("Usu√°rio n√£o autenticado."),console.error("Erro de autentica√ß√£o:",l);return}const N=d.user.id;let C=[];try{C=await L(o)}catch(y){alert("Erro ao fazer upload das imagens: "+y.message),console.error("Erro upload imagens:",y);return}const{data:I,error:g}=await m.from("anuncios").insert([{user_id:N,titulo:t,autora:a,paginas:i,editora:r,sobre:c,imagens:C}]);if(g){alert("Erro ao inserir no banco: "+g.message),console.error("Erro insert:",g);return}console.log("Insert data:",I),alert("Livro cadastrado com sucesso!"),E.reset(),u=[],p()}catch(d){alert("Erro inesperado ao cadastrar livro: "+d.message),console.error("Erro inesperado:",d)}})}async function B(){try{const{data:{user:e}}=await m.auth.getUser();if(!e)return console.error("Usu√°rio n√£o autenticado"),[];const{data:n,error:t}=await m.from("anuncios").select("id, user_id, titulo, autora, paginas, editora, sobre, imagens, status").eq("user_id",e.id);return t?(console.error("Erro ao buscar an√∫ncios:",t),console.error("Detalhes do erro:",JSON.stringify(t,null,2)),[]):(console.log("An√∫ncios encontrados:",n),n||[])}catch(e){return console.error("Erro inesperado ao buscar an√∫ncios:",e),[]}}async function b(e,n){try{const t=n==="EM ABERTO"?"FECHADO":"EM ABERTO",{error:a}=await m.from("anuncios").update({status:t}).eq("id",e);return a?(console.error("Erro ao atualizar status:",a),alert("Erro ao atualizar an√∫ncio. Tente novamente."),!1):!0}catch(t){return console.error("Erro inesperado:",t),alert("Erro inesperado. Tente novamente."),!1}}function M(e){const n=document.createElement("div"),t=e.status||"EM ABERTO";n.className=`anuncio-card ${t==="FECHADO"?"fechado":""}`;const a=document.createElement("div");a.className="anuncio-header";const i=document.createElement("div");i.className="anuncio-titulo",i.textContent=e.titulo;const r=document.createElement("span");r.className=`anuncio-status-badge ${t==="EM ABERTO"?"em-aberto":"fechado"}`,r.textContent=t,a.appendChild(i),a.appendChild(r);const c=document.createElement("div");if(c.className="anuncio-info",c.innerHTML=`
    <strong>Autor:</strong> ${e.autora}<br>
    <strong>Editora:</strong> ${e.editora}<br>
    <strong>P√°ginas:</strong> ${e.paginas}
  `,n.appendChild(a),e.imagens&&e.imagens.length>0){const o=document.createElement("img");o.src=e.imagens[0],o.alt=e.titulo,o.className="anuncio-imagem",n.appendChild(o)}n.appendChild(c);const s=document.createElement("div");if(s.className="anuncio-actions",t==="EM ABERTO"){const o=document.createElement("button");o.className="btn-fechar-anuncio",o.textContent="Fechar An√∫ncio",o.addEventListener("click",async()=>{confirm("Deseja realmente fechar este an√∫ncio? Ele n√£o aparecer√° mais na p√°gina inicial.")&&await b(e.id,t)&&h()}),s.appendChild(o)}else{const o=document.createElement("button");o.className="btn-reabrir-anuncio",o.textContent="Reabrir An√∫ncio",o.addEventListener("click",async()=>{await b(e.id,t)&&h()}),s.appendChild(o)}return n.appendChild(s),n}async function h(){const e=await B(),n=document.getElementById("anuncios-list");if(n){if(n.innerHTML="",e.length===0){const t=document.createElement("p");t.textContent="Voc√™ ainda n√£o tem an√∫ncios cadastrados.",t.style.textAlign="center",t.style.color="#6b7280",n.appendChild(t);return}e.forEach(t=>{n.appendChild(M(t))})}}async function T(){try{const{data:{user:e}}=await m.auth.getUser();if(!e)return console.error("Usu√°rio n√£o autenticado"),[];const{data:n,error:t}=await m.from("propostas").select(`
        id,
        anuncio_id,
        interessado_id,
        anunciante_id,
        mensagem,
        valor_oferecido,
        imagens,
        status,
        created_at,
        anuncios:anuncio_id (titulo),
        profiles:interessado_id (username, name, phone)
      `).eq("anunciante_id",e.id).order("created_at",{ascending:!1});return t?(console.error("Erro ao buscar propostas:",t),[]):(n||[]).map(a=>({id:a.id,anuncio_id:a.anuncio_id,interessado_id:a.interessado_id,anunciante_id:a.anunciante_id,mensagem:a.mensagem,valor_oferecido:a.valor_oferecido,imagens:a.imagens,status:a.status,created_at:a.created_at,anuncio_titulo:a.anuncios?.titulo||"An√∫ncio n√£o encontrado",interessado_username:a.profiles?.username||a.profiles?.name||"Usu√°rio desconhecido",interessado_phone:a.profiles?.phone||null}))}catch(e){return console.error("Erro inesperado ao buscar propostas:",e),[]}}function A(e){const n=document.createElement("div");n.className=`proposta-card ${e.status}`;const t=document.createElement("div");t.className="proposta-header";const a=document.createElement("div");a.className="proposta-titulo",a.textContent=e.anuncio_titulo||"Sem t√≠tulo";const i=document.createElement("span");i.className=`proposta-status ${e.status}`,i.textContent=e.status,t.appendChild(a),t.appendChild(i);const r=document.createElement("div");r.className="proposta-info",r.textContent=`De: ${e.interessado_username}`;const c=document.createElement("div");return c.className="proposta-valor",c.textContent=e.valor_oferecido?`R$ ${e.valor_oferecido.toFixed(2)}`:"Sem valor definido",n.appendChild(t),n.appendChild(r),n.appendChild(c),n.addEventListener("click",()=>$(e)),n}function $(e){const n=document.getElementById("proposta-modal"),t=document.getElementById("modal-body");if(!n||!t)return;t.innerHTML="";const a=document.createElement("div");a.className="modal-proposta-info",a.innerHTML=`<strong>An√∫ncio:</strong> ${e.anuncio_titulo}`,t.appendChild(a);const i=document.createElement("div");if(i.className="modal-proposta-info",i.innerHTML=`<strong>Interessado:</strong> ${e.interessado_username}`,t.appendChild(i),e.status==="aceita"&&e.interessado_phone){const o=document.createElement("div");o.className="modal-proposta-info contact-info",o.innerHTML=`<strong>üì± Telefone para contato:</strong> <a href="tel:${e.interessado_phone}">${e.interessado_phone}</a>`,t.appendChild(o)}const r=document.createElement("div");r.className="modal-proposta-info",r.innerHTML=`<strong>Valor Oferecido:</strong> ${e.valor_oferecido?`R$ ${e.valor_oferecido.toFixed(2)}`:"N√£o informado"}`,t.appendChild(r);const c=document.createElement("div");c.className="modal-proposta-info",c.innerHTML=`<strong>Mensagem:</strong><br>${e.mensagem||"Sem mensagem"}`,t.appendChild(c);const s=document.createElement("div");if(s.className="modal-proposta-info",s.innerHTML=`<strong>Status:</strong> <span class="proposta-status ${e.status}">${e.status}</span>`,t.appendChild(s),e.imagens&&e.imagens.length>0){const o=document.createElement("div");o.className="modal-images",e.imagens.forEach(d=>{const l=document.createElement("img");l.src=d,l.alt="Imagem da proposta",o.appendChild(l)}),t.appendChild(o)}if(e.status==="pendente"){const o=document.createElement("div");o.className="modal-actions";const d=document.createElement("button");d.className="btn-aceitar",d.textContent="Aceitar",d.addEventListener("click",async()=>{await _(e.id,"aceita"),f(),v()});const l=document.createElement("button");l.className="btn-recusar",l.textContent="Recusar",l.addEventListener("click",async()=>{await _(e.id,"recusada"),f(),v()}),o.appendChild(d),o.appendChild(l),t.appendChild(o)}n.classList.add("show")}function f(){const e=document.getElementById("proposta-modal");e&&e.classList.remove("show")}async function _(e,n){try{const{error:t}=await m.from("propostas").update({status:n}).eq("id",e);t?(console.error("Erro ao atualizar status:",t),alert("Erro ao atualizar proposta. Tente novamente.")):alert(`Proposta ${n} com sucesso!`)}catch(t){console.error("Erro inesperado:",t),alert("Erro inesperado. Tente novamente.")}}async function v(){const e=await T(),n=document.getElementById("propostas-list");if(n){if(n.innerHTML="",e.length===0){const t=document.createElement("p");t.textContent="Nenhuma proposta recebida.",t.style.textAlign="center",t.style.color="#6b7280",n.appendChild(t);return}e.forEach(t=>{n.appendChild(A(t))})}}document.addEventListener("DOMContentLoaded",()=>{h(),v();const e=document.querySelector(".close-modal");e&&e.addEventListener("click",f);const n=document.getElementById("proposta-modal");n&&n.addEventListener("click",t=>{t.target===n&&f()})});
