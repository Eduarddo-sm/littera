import{a as d,s as m}from"./popup-B9BBiTrj.js";/* empty css              */const E=document.getElementById("form-cadastrar-livro");let p=[];function f(){const e=document.getElementById("image-preview");e&&(e.innerHTML="",p.forEach((n,t)=>{const a=new FileReader;a.onload=s=>{const r=document.createElement("div");r.className="image-preview-item";const c=document.createElement("img");c.src=s.target?.result;const i=document.createElement("button");i.className="image-preview-remove",i.innerHTML="√ó",i.type="button",i.onclick=()=>{p.splice(t,1),f(),L()},r.appendChild(c),r.appendChild(i),e.appendChild(r)},a.readAsDataURL(n)}))}function L(){const e=document.getElementById("imagem");if(!e)return;const n=new DataTransfer;p.forEach(t=>n.items.add(t)),e.files=n.files}async function T(e){const n=[];for(let t=0;t<Math.min(e.length,5);t++){const a=e[t],s=a.name.split(".").pop(),r=`public/${Date.now()}-${Math.random().toString(36).substring(2,8)}.${s}`,{data:c,error:i}=await m.storage.from("livros").upload(r,a);if(i)throw i;const{data:o}=m.storage.from("livros").getPublicUrl(r);n.push(o.publicUrl)}return n}if(E){const e=document.getElementById("imagem");e&&e.addEventListener("change",n=>{const t=n.target.files;if(t){if(t.length>5){d("Voc√™ pode selecionar no m√°ximo 5 imagens.",3e3,0),e.value="",p=[],f();return}p=Array.from(t),f()}}),E.addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("titulo").value,a=document.getElementById("autora").value,s=parseInt(document.getElementById("paginas").value,10),r=document.getElementById("editora").value,c=document.getElementById("sobre").value,o=document.getElementById("imagem").files;if(!o||o.length===0){d("Selecione pelo menos uma imagem.",3e3,0);return}if(o.length>5){d("Voc√™ pode enviar no m√°ximo 5 imagens.",3e3,0);return}try{const{data:l,error:u}=await m.auth.getUser();if(u||!l?.user){d("Usu√°rio n√£o autenticado.",3e3,0),console.error("Erro de autentica√ß√£o:",u);return}const N=l.user.id;let C=[];try{C=await T(o)}catch(I){d("Erro ao fazer upload das imagens. Tente novamente.",3e3,0),console.error("Erro upload imagens:",I);return}const{data:w,error:y}=await m.from("anuncios").insert([{user_id:N,titulo:t,autora:a,paginas:s,editora:r,sobre:c,imagens:C}]);if(y){d("Erro ao inserir no banco: ",3e3,0),console.error("Erro insert:",y);return}console.log("Insert data:",w),d("Livro cadastrado com sucesso!",3e3,1),E.reset(),p=[],f()}catch(l){d("Erro inesperado ao cadastrar livro: ",3e3,0),console.error("Erro inesperado:",l)}})}async function B(){try{const{data:{user:e}}=await m.auth.getUser();if(!e)return console.error("Usu√°rio n√£o autenticado"),[];const{data:n,error:t}=await m.from("anuncios").select("id, user_id, titulo, autora, paginas, editora, sobre, imagens, status").eq("user_id",e.id);return t?(console.error("Erro ao buscar an√∫ncios:",t),console.error("Detalhes do erro:",JSON.stringify(t,null,2)),[]):n||[]}catch(e){return console.error("Erro inesperado ao buscar an√∫ncios:",e),[]}}async function b(e,n){try{const t=n==="EM ABERTO"?"FECHADO":"EM ABERTO",{error:a}=await m.from("anuncios").update({status:t}).eq("id",e);return a?(console.error("Erro ao atualizar status:",a),d("Erro ao atualizar an√∫ncio. Tente novamente.",3e3,0),!1):!0}catch(t){return console.error("Erro inesperado:",t),d("Erro inesperado. Tente novamente.",3e3,0),!1}}function M(e){const n=document.createElement("div"),t=e.status||"EM ABERTO";n.className=`anuncio-card ${t==="FECHADO"?"fechado":""}`;const a=document.createElement("div");a.className="anuncio-header";const s=document.createElement("div");s.className="anuncio-titulo",s.textContent=e.titulo;const r=document.createElement("span");r.className=`anuncio-status-badge ${t==="EM ABERTO"?"em-aberto":"fechado"}`,r.textContent=t,a.appendChild(s),a.appendChild(r);const c=document.createElement("div");if(c.className="anuncio-info",c.innerHTML=`
    <strong>Autor:</strong> ${e.autora}<br>
    <strong>Editora:</strong> ${e.editora}<br>
    <strong>P√°ginas:</strong> ${e.paginas}
  `,n.appendChild(a),e.imagens&&e.imagens.length>0){const o=document.createElement("img");o.src=e.imagens[0],o.alt=e.titulo,o.className="anuncio-imagem",n.appendChild(o)}n.appendChild(c);const i=document.createElement("div");if(i.className="anuncio-actions",t==="EM ABERTO"){const o=document.createElement("button");o.className="btn-fechar-anuncio",o.textContent="Fechar An√∫ncio",o.addEventListener("click",async()=>{confirm("Deseja realmente fechar este an√∫ncio? Ele n√£o aparecer√° mais na p√°gina inicial.")&&await b(e.id,t)&&h()}),i.appendChild(o)}else{const o=document.createElement("button");o.className="btn-reabrir-anuncio",o.textContent="Reabrir An√∫ncio",o.addEventListener("click",async()=>{await b(e.id,t)&&h()}),i.appendChild(o)}return n.appendChild(i),n}async function h(){const e=await B(),n=document.getElementById("anuncios-list");if(n){if(n.innerHTML="",e.length===0){const t=document.createElement("p");t.textContent="Voc√™ ainda n√£o tem an√∫ncios cadastrados.",t.style.textAlign="center",t.style.color="#6b7280",n.appendChild(t);return}e.forEach(t=>{n.appendChild(M(t))})}}async function $(){try{const{data:{user:e}}=await m.auth.getUser();if(!e)return console.error("Usu√°rio n√£o autenticado"),[];const{data:n,error:t}=await m.from("propostas").select(`
        id,
        anuncio_id,
        interessado_id,
        anunciante_id,
        mensagem,
        valor_oferecido,
        imagens,
        status,
        created_at,
        anuncios:anuncio_id (titulo),
        profiles:interessado_id (username, name, phone)
      `).eq("anunciante_id",e.id).order("created_at",{ascending:!1});return t?(console.error("Erro ao buscar propostas:",t),[]):(n||[]).map(a=>({id:a.id,anuncio_id:a.anuncio_id,interessado_id:a.interessado_id,anunciante_id:a.anunciante_id,mensagem:a.mensagem,valor_oferecido:a.valor_oferecido,imagens:a.imagens,status:a.status,created_at:a.created_at,anuncio_titulo:a.anuncios?.titulo||"An√∫ncio n√£o encontrado",interessado_username:a.profiles?.username||a.profiles?.name||"Usu√°rio desconhecido",interessado_phone:a.profiles?.phone||null}))}catch(e){return console.error("Erro inesperado ao buscar propostas:",e),[]}}function A(e){const n=document.createElement("div");n.className=`proposta-card ${e.status}`;const t=document.createElement("div");t.className="proposta-header";const a=document.createElement("div");a.className="proposta-titulo",a.textContent=e.anuncio_titulo||"Sem t√≠tulo";const s=document.createElement("span");s.className=`proposta-status ${e.status}`,s.textContent=e.status,t.appendChild(a),t.appendChild(s);const r=document.createElement("div");r.className="proposta-info",r.textContent=`De: ${e.interessado_username}`;const c=document.createElement("div");return c.className="proposta-valor",c.textContent=e.valor_oferecido?`R$ ${e.valor_oferecido.toFixed(2)}`:"Sem valor definido",n.appendChild(t),n.appendChild(r),n.appendChild(c),n.addEventListener("click",()=>x(e)),n}function x(e){const n=document.getElementById("proposta-modal"),t=document.getElementById("modal-body");if(!n||!t)return;t.innerHTML="";const a=document.createElement("div");a.className="modal-proposta-info",a.innerHTML=`<strong>An√∫ncio:</strong> ${e.anuncio_titulo}`,t.appendChild(a);const s=document.createElement("div");if(s.className="modal-proposta-info",s.innerHTML=`<strong>Interessado:</strong> ${e.interessado_username}`,t.appendChild(s),e.status==="aceita"&&e.interessado_phone){const o=document.createElement("div");o.className="modal-proposta-info contact-info",o.innerHTML=`<strong>üì± Telefone para contato:</strong> <a href="tel:${e.interessado_phone}">${e.interessado_phone}</a>`,t.appendChild(o)}const r=document.createElement("div");r.className="modal-proposta-info",r.innerHTML=`<strong>Valor Oferecido:</strong> ${e.valor_oferecido?`R$ ${e.valor_oferecido.toFixed(2)}`:"N√£o informado"}`,t.appendChild(r);const c=document.createElement("div");c.className="modal-proposta-info",c.innerHTML=`<strong>Mensagem:</strong><br>${e.mensagem||"Sem mensagem"}`,t.appendChild(c);const i=document.createElement("div");if(i.className="modal-proposta-info",i.innerHTML=`<strong>Status:</strong> <span class="proposta-status ${e.status}">${e.status}</span>`,t.appendChild(i),e.imagens&&e.imagens.length>0){const o=document.createElement("div");o.className="modal-images",e.imagens.forEach(l=>{const u=document.createElement("img");u.src=l,u.alt="Imagem da proposta",o.appendChild(u)}),t.appendChild(o)}if(e.status==="pendente"){const o=document.createElement("div");o.className="modal-actions";const l=document.createElement("button");l.className="btn-aceitar",l.textContent="Aceitar",l.addEventListener("click",async()=>{await _(e.id,"aceita"),g(),v()});const u=document.createElement("button");u.className="btn-recusar",u.textContent="Recusar",u.addEventListener("click",async()=>{await _(e.id,"recusada"),g(),v()}),o.appendChild(l),o.appendChild(u),t.appendChild(o)}n.classList.add("show")}function g(){const e=document.getElementById("proposta-modal");e&&e.classList.remove("show")}async function _(e,n){try{const{data:t,error:a}=await m.from("propostas").select("anuncio_id").eq("id",e).single();if(a){console.error("Erro ao buscar proposta:",a),d("Erro ao buscar proposta. Tente novamente.",3e3,0);return}const{error:s}=await m.from("propostas").update({status:n}).eq("id",e);if(s){console.error("Erro ao atualizar status:",s),d("Erro ao atualizar proposta. Tente novamente.",3e3,0);return}if(n==="aceita"&&t?.anuncio_id){const{error:r}=await m.from("anuncios").update({status:"FECHADO"}).eq("id",t.anuncio_id);r&&console.error("Erro ao fechar an√∫ncio:",r)}d(`Proposta ${n} com sucesso!${n==="aceita"?" O an√∫ncio foi fechado automaticamente.":""}`,3e3,2)}catch(t){console.error("Erro inesperado:",t),d("Erro inesperado. Tente novamente.",3e3,0)}}async function v(){const e=await $(),n=document.getElementById("propostas-list");if(n){if(n.innerHTML="",e.length===0){const t=document.createElement("p");t.textContent="Nenhuma proposta recebida.",t.style.textAlign="center",t.style.color="#6b7280",n.appendChild(t);return}e.forEach(t=>{n.appendChild(A(t))})}}document.addEventListener("DOMContentLoaded",()=>{h(),v();const e=document.querySelector(".close-modal");e&&e.addEventListener("click",g);const n=document.getElementById("proposta-modal");n&&n.addEventListener("click",t=>{t.target===n&&g()})});
