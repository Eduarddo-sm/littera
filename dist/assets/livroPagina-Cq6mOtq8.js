import{s as c,c as v}from"./supabase-DontodQT.js";function I(){return new URLSearchParams(window.location.search).get("id")}async function P(e){const{data:t,error:n}=await c.from("anuncios").select(`
      user_id,
      profiles(
          avatar_url,
          username
          )
      `).eq("id",e).single();return n?(console.error("Erro ao buscar perfil do usuário:",n),null):t}async function B(e){try{const{data:{user:t}}=await c.auth.getUser();if(!t)return console.log("Usuário não autenticado"),null;console.log("Buscando proposta com:",{anuncio_id:e,user_id:t.id});const{data:n,error:o}=await c.from("propostas").select("status, created_at, anuncio_id, interessado_id, anunciante_id").eq("anuncio_id",e).or(`interessado_id.eq.${t.id},anunciante_id.eq.${t.id}`).order("created_at",{ascending:!1}).limit(1);if(console.log("Resultado da busca:",{data:n,error:o}),o)return console.error("Erro ao buscar status da proposta:",o),null;if(!n||n.length===0)return console.log("Nenhuma proposta encontrada para este usuário"),null;console.log("Proposta encontrada:",n[0]);const r=n[0];return r.userRole=r.interessado_id===t.id?"interessado":"anunciante",r}catch(t){return console.error("Erro ao buscar proposta:",t),null}}async function h(e){const{data:t,error:n}=await c.from("anuncios").select("id, titulo, autora, paginas, editora, sobre, imagens, status").eq("id",e).single();return n?(console.error("Erro ao buscar livro:",n),null):t}function _(e,t=null){if(!e||!e.profiles)return;const n=document.getElementById("anunciador-link"),o=n?.querySelector("img"),r=n?.querySelector("p"),a=document.getElementById("proposta-status"),s=e.profiles;if(o)if(s?.avatar_url){const{data:u}=c.storage.from("userProfiles").getPublicUrl(s.avatar_url);o.src=u.publicUrl,o.alt=s?.username||"Avatar do usuário"}else o.src="../../images/default-avatar.png",o.alt="Avatar padrão";if(r&&(r.textContent=s?.username||"Usuário"),n&&(n.href=`/perfil.html?id=${e.user_id}`),a&&t){const u={pendente:(t.userRole==="anunciante","Pendente"),aceita:"Encerrado",recusada:"Encerrada"};a.textContent=u[t.status]||"Status desconhecido",a.className=`status-badge status-${t.status}`,a.style.display="inline-block"}else a&&(a.style.display="none")}let l=0,i=0;function w(e){if(!e)return;const t=document.getElementById("livro-titulo"),n=document.getElementById("livro-autor"),o=document.getElementById("numero-paginas"),r=document.getElementById("livro-editora"),a=document.getElementById("livro-descricao"),s=document.getElementById("livro-imagens");t&&(t.textContent=`${e.titulo}`),a&&(a.textContent=`Descrição: ${e.sobre||"Descrição não disponível"}`),n&&(n.textContent=`Autor: ${e.autora||"Autor não disponível"}`),o&&(o.textContent=`Número de páginas: ${e.paginas||"N/A"}`),r&&(r.textContent=`Editora: ${e.editora||"Editora não disponível"}`),s&&e.imagens&&e.imagens.length>0&&(i=e.imagens.length,l=0,y(s,e.imagens,e.titulo),C(s,e.imagens,e.titulo))}function y(e,t,n){if(e.innerHTML="",t.length>0){const o=document.createElement("img");o.src=t[l],o.alt=`${n} - Imagem ${l+1} de ${i}`,o.className="livro-img",e.appendChild(o)}}function C(e,t,n){const o=document.getElementById("btn-prev-img"),r=document.getElementById("btn-next-img");(()=>{o&&(o.style.display=i>1?"block":"none"),r&&(r.style.display=i>1?"block":"none")})(),o&&o.addEventListener("click",()=>{l=(l-1+i)%i,y(e,t,n)}),r&&r.addEventListener("click",()=>{l=(l+1)%i,y(e,t,n)})}document.addEventListener("DOMContentLoaded",async()=>{const e=I();if(console.log("ID do anúncio na URL:",e),!e)return;const t=await h(e),n=await P(e),o=await B(e);console.log("Proposta Status final:",o),console.log("Status do livro:",t?.status),w(t),_(n,o);const r=document.getElementById("btn-proposta");r&&t&&t.status==="FECHADO"&&(r.disabled=!0,r.textContent="Anúncio Fechado",r.style.background="#9ca3af",r.style.cursor="not-allowed")});const x=void 0,U=void 0,d=v(x,U);async function $(e){try{const t=e.name.split(".").pop(),o=`public/${`${Math.random()}.${t}`}`,{data:r,error:a}=await d.storage.from("proposta").upload(o,e);if(a)return console.error("Erro ao fazer upload da imagem:",a),null;const{data:{publicUrl:s}}=d.storage.from("proposta").getPublicUrl(o);return s}catch(t){return console.error("Erro ao fazer upload da imagem:",t),null}}async function L(e){try{const{error:t}=await d.from("propostas").insert([e]);return t?(console.error("Erro ao enviar proposta:",t),!1):!0}catch(t){return console.error("Erro ao enviar proposta:",t),!1}}function E(){const e=document.getElementById("proposta-modal"),t=document.getElementById("btn-proposta"),n=document.getElementById("close-modal"),o=document.getElementById("proposta-form");if(!e||!t||!n||!o){console.error("Elementos do modal não encontrados");return}t.addEventListener("click",()=>{e.style.display="flex"}),n.addEventListener("click",()=>{e.style.display="none",o.reset()}),window.addEventListener("click",r=>{r.target===e&&(e.style.display="none",o.reset())}),o.addEventListener("submit",async r=>{r.preventDefault();const a=o.querySelector('button[type="submit"]');a.disabled=!0,a.textContent="Enviando...";try{const{data:{user:s}}=await d.auth.getUser();if(!s){alert("Você precisa estar logado para enviar uma proposta"),a.disabled=!1,a.textContent="Enviar Proposta";return}const p=new URLSearchParams(window.location.search).get("id");if(!p){alert("ID do anúncio não encontrado"),a.disabled=!1,a.textContent="Enviar Proposta";return}const{data:f}=await d.from("anuncios").select("user_id, status").eq("id",p).single();if(!f){alert("Anúncio não encontrado"),a.disabled=!1,a.textContent="Enviar Proposta";return}if(f.status==="FECHADO"){alert("Este anúncio já está fechado e não aceita mais propostas."),e.style.display="none",a.disabled=!1,a.textContent="Enviar Proposta";return}const g=document.getElementById("imagem");let m=null;if(g.files&&g.files[0]&&(m=await $(g.files[0]),!m)){alert("Erro ao fazer upload da imagem. Tente novamente."),a.disabled=!1,a.textContent="Enviar Proposta";return}const b={anuncio_id:p,interessado_id:s.id,anunciante_id:f.user_id,mensagem:document.getElementById("mensagem").value,valor_oferecido:parseFloat(document.getElementById("valor_oferecido").value),imagens:m?[m]:void 0};await L(b)?(alert("Proposta enviada com sucesso!"),e.style.display="none",o.reset()):alert("Erro ao enviar proposta. Tente novamente.")}catch(s){console.error("Erro ao processar proposta:",s),alert("Erro ao enviar proposta. Tente novamente.")}finally{a.disabled=!1,a.textContent="Enviar Proposta"}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",E):E();
