import{s as m}from"./supabase-BafKp-QD.js";const g=document.getElementById("form-cadastrar-livro");async function y(e){const a=[];for(let t=0;t<Math.min(e.length,5);t++){const n=e[t],s=n.name.split(".").pop(),r=`public/${Date.now()}-${Math.random().toString(36).substring(2,8)}.${s}`,{data:d,error:i}=await m.storage.from("livros").upload(r,n);if(i)throw i;const{data:o}=m.storage.from("livros").getPublicUrl(r);a.push(o.publicUrl)}return a}g&&g.addEventListener("submit",async e=>{e.preventDefault();const a=document.getElementById("titulo").value,t=document.getElementById("autora").value,n=parseInt(document.getElementById("paginas").value,10),s=document.getElementById("editora").value,r=document.getElementById("sobre").value,i=document.getElementById("imagem").files;if(!i||i.length===0){alert("Selecione pelo menos uma imagem.");return}try{const{data:o,error:l}=await m.auth.getUser();if(l||!o?.user){alert("Usuário não autenticado."),console.error("Erro de autenticação:",l);return}const c=o.user.id;let E=[];try{E=await y(i)}catch(v){alert("Erro ao fazer upload das imagens: "+v.message),console.error("Erro upload imagens:",v);return}const{data:_,error:p}=await m.from("anuncios").insert([{user_id:c,titulo:a,autora:t,paginas:n,editora:s,sobre:r,imagens:E}]);if(p){alert("Erro ao inserir no banco: "+p.message),console.error("Erro insert:",p);return}console.log("Insert data:",_),alert("Livro cadastrado com sucesso!"),g.reset()}catch(o){alert("Erro inesperado ao cadastrar livro: "+o.message),console.error("Erro inesperado:",o)}});async function C(){try{const{data:{user:e}}=await m.auth.getUser();if(!e)return console.error("Usuário não autenticado"),[];const{data:a,error:t}=await m.from("propostas").select(`
        id,
        anuncio_id,
        interessado_id,
        anunciante_id,
        mensagem,
        valor_oferecido,
        imagens,
        status,
        created_at,
        anuncios:anuncio_id (titulo),
        profiles:interessado_id (username, name)
      `).eq("anunciante_id",e.id).order("created_at",{ascending:!1});return t?(console.error("Erro ao buscar propostas:",t),[]):(a||[]).map(n=>({id:n.id,anuncio_id:n.anuncio_id,interessado_id:n.interessado_id,anunciante_id:n.anunciante_id,mensagem:n.mensagem,valor_oferecido:n.valor_oferecido,imagens:n.imagens,status:n.status,created_at:n.created_at,anuncio_titulo:n.anuncios?.titulo||"Anúncio não encontrado",interessado_username:n.profiles?.username||n.profiles?.name||"Usuário desconhecido"}))}catch(e){return console.error("Erro inesperado ao buscar propostas:",e),[]}}function b(e){const a=document.createElement("div");a.className=`proposta-card ${e.status}`;const t=document.createElement("div");t.className="proposta-header";const n=document.createElement("div");n.className="proposta-titulo",n.textContent=e.anuncio_titulo||"Sem título";const s=document.createElement("span");s.className=`proposta-status ${e.status}`,s.textContent=e.status,t.appendChild(n),t.appendChild(s);const r=document.createElement("div");r.className="proposta-info",r.textContent=`De: ${e.interessado_username}`;const d=document.createElement("div");return d.className="proposta-valor",d.textContent=e.valor_oferecido?`R$ ${e.valor_oferecido.toFixed(2)}`:"Sem valor definido",a.appendChild(t),a.appendChild(r),a.appendChild(d),a.addEventListener("click",()=>I(e)),a}function I(e){const a=document.getElementById("proposta-modal"),t=document.getElementById("modal-body");if(!a||!t)return;t.innerHTML="";const n=document.createElement("div");n.className="modal-proposta-info",n.innerHTML=`<strong>Anúncio:</strong> ${e.anuncio_titulo}`,t.appendChild(n);const s=document.createElement("div");s.className="modal-proposta-info",s.innerHTML=`<strong>Interessado:</strong> ${e.interessado_username}`,t.appendChild(s);const r=document.createElement("div");r.className="modal-proposta-info",r.innerHTML=`<strong>Valor Oferecido:</strong> ${e.valor_oferecido?`R$ ${e.valor_oferecido.toFixed(2)}`:"Não informado"}`,t.appendChild(r);const d=document.createElement("div");d.className="modal-proposta-info",d.innerHTML=`<strong>Mensagem:</strong><br>${e.mensagem||"Sem mensagem"}`,t.appendChild(d);const i=document.createElement("div");if(i.className="modal-proposta-info",i.innerHTML=`<strong>Status:</strong> <span class="proposta-status ${e.status}">${e.status}</span>`,t.appendChild(i),e.imagens&&e.imagens.length>0){const o=document.createElement("div");o.className="modal-images",e.imagens.forEach(l=>{const c=document.createElement("img");c.src=l,c.alt="Imagem da proposta",o.appendChild(c)}),t.appendChild(o)}if(e.status==="pendente"){const o=document.createElement("div");o.className="modal-actions";const l=document.createElement("button");l.className="btn-aceitar",l.textContent="Aceitar",l.addEventListener("click",async()=>{await h(e.id,"aceita"),u(),f()});const c=document.createElement("button");c.className="btn-recusar",c.textContent="Recusar",c.addEventListener("click",async()=>{await h(e.id,"recusada"),u(),f()}),o.appendChild(l),o.appendChild(c),t.appendChild(o)}a.classList.add("show")}function u(){const e=document.getElementById("proposta-modal");e&&e.classList.remove("show")}async function h(e,a){try{const{error:t}=await m.from("propostas").update({status:a}).eq("id",e);t?(console.error("Erro ao atualizar status:",t),alert("Erro ao atualizar proposta. Tente novamente.")):alert(`Proposta ${a} com sucesso!`)}catch(t){console.error("Erro inesperado:",t),alert("Erro inesperado. Tente novamente.")}}async function f(){const e=await C(),a=document.getElementById("propostas-list");if(a){if(a.innerHTML="",e.length===0){const t=document.createElement("p");t.textContent="Nenhuma proposta recebida.",t.style.textAlign="center",t.style.color="#6b7280",a.appendChild(t);return}e.forEach(t=>{a.appendChild(b(t))})}}document.addEventListener("DOMContentLoaded",()=>{f();const e=document.querySelector(".close-modal");e&&e.addEventListener("click",u);const a=document.getElementById("proposta-modal");a&&a.addEventListener("click",t=>{t.target===a&&u()})});
