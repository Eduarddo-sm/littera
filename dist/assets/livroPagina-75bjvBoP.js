import{s as l,c as v,a as i}from"./popup-B9BBiTrj.js";/* empty css              */function h(){return new URLSearchParams(window.location.search).get("id")}async function B(e){const{data:t,error:o}=await l.from("anuncios").select(`
      user_id,
      profiles(
          avatar_url,
          username
          )
      `).eq("id",e).single();return o?(console.error("Erro ao buscar perfil do usuário:",o),null):t}async function C(e){try{const{data:{user:t}}=await l.auth.getUser();if(!t)return console.log("Usuário não autenticado"),null;const{data:o,error:n}=await l.from("propostas").select("status, created_at, anuncio_id, interessado_id, anunciante_id").eq("anuncio_id",e).or(`interessado_id.eq.${t.id},anunciante_id.eq.${t.id}`).order("created_at",{ascending:!1}).limit(1);if(n)return console.error("Erro ao buscar status da proposta:",n),null;if(!o||o.length===0)return null;const r=o[0];return r.userRole=r.interessado_id===t.id?"interessado":"anunciante",r}catch(t){return console.error("Erro ao buscar proposta:",t),null}}async function P(e){const{data:t,error:o}=await l.from("anuncios").select("id, titulo, autora, paginas, editora, sobre, imagens, status").eq("id",e).single();return o?(console.error("Erro ao buscar livro:",o),null):t}function w(e,t=null){if(!e||!e.profiles)return;const o=document.getElementById("anunciador-link"),n=o?.querySelector("img"),r=o?.querySelector("p"),a=document.getElementById("proposta-status"),s=e.profiles;if(n)if(s?.avatar_url){const{data:m}=l.storage.from("userProfiles").getPublicUrl(s.avatar_url);n.src=m.publicUrl,n.alt=s?.username||"Avatar do usuário"}else n.src="../../images/default-avatar.png",n.alt="Avatar padrão";if(r&&(r.textContent=s?.username||"Usuário"),o&&(o.href=`/perfil.html?id=${e.user_id}`),a&&t){const m={pendente:(t.userRole==="anunciante","Pendente"),aceita:"Encerrado",recusada:"Encerrada"};a.textContent=m[t.status]||"Status desconhecido",a.className=`status-badge status-${t.status}`,a.style.display="inline-block"}else a&&(a.style.display="none")}let d=0,c=0;function x(e){if(!e)return;const t=document.getElementById("livro-titulo"),o=document.getElementById("livro-autor"),n=document.getElementById("numero-paginas"),r=document.getElementById("livro-editora"),a=document.getElementById("livro-descricao"),s=document.getElementById("livro-imagens");t&&(t.textContent=`${e.titulo}`),a&&(a.textContent=`Descrição: ${e.sobre||"Descrição não disponível"}`),o&&(o.textContent=`Autor: ${e.autora||"Autor não disponível"}`),n&&(n.textContent=`Número de páginas: ${e.paginas||"N/A"}`),r&&(r.textContent=`Editora: ${e.editora||"Editora não disponível"}`),s&&e.imagens&&e.imagens.length>0&&(c=e.imagens.length,d=0,E(s,e.imagens,e.titulo),_(s,e.imagens,e.titulo))}function E(e,t,o){if(e.innerHTML="",t.length>0){const n=document.createElement("img");n.src=t[d],n.alt=`${o} - Imagem ${d+1} de ${c}`,n.className="livro-img",e.appendChild(n)}}function _(e,t,o){const n=document.getElementById("btn-prev-img"),r=document.getElementById("btn-next-img");(()=>{n&&(n.style.display=c>1?"block":"none"),r&&(r.style.display=c>1?"block":"none")})(),n&&n.addEventListener("click",()=>{d=(d-1+c)%c,E(e,t,o)}),r&&r.addEventListener("click",()=>{d=(d+1)%c,E(e,t,o)})}document.addEventListener("DOMContentLoaded",async()=>{const e=h();if(!e)return;const t=await P(e),o=await B(e),n=await C(e);x(t),w(o,n);const r=document.getElementById("btn-proposta");r&&t&&t.status==="FECHADO"&&(r.disabled=!0,r.textContent="Anúncio Fechado",r.style.background="#323232",r.style.cursor="not-allowed")});const k="https://kqepdklhdblxbslyhzhv.supabase.co",N="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxZXBka2xoZGJseGJzbHloemh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTYzODcsImV4cCI6MjA3NTAzMjM4N30.sW6NYNjItYjGaTc1oC06Id-c5rsYoZcQpXFlbcj-nBI",u=v(k,N);async function U(e){try{const t=e.name.split(".").pop(),n=`public/${`${Math.random()}.${t}`}`,{data:r,error:a}=await u.storage.from("proposta").upload(n,e);if(a)return console.error("Erro ao fazer upload da imagem:",a),null;const{data:{publicUrl:s}}=u.storage.from("proposta").getPublicUrl(n);return s}catch(t){return console.error("Erro ao fazer upload da imagem:",t),null}}async function $(e){try{const{error:t}=await u.from("propostas").insert([e]);return t?(console.error("Erro ao enviar proposta:",t),!1):!0}catch(t){return console.error("Erro ao enviar proposta:",t),!1}}function I(){const e=document.getElementById("proposta-modal"),t=document.getElementById("btn-proposta"),o=document.getElementById("close-modal"),n=document.getElementById("proposta-form");if(!e||!t||!o||!n){console.error("Elementos do modal não encontrados");return}t.addEventListener("click",()=>{e.style.display="flex"}),o.addEventListener("click",()=>{e.style.display="none",n.reset()}),window.addEventListener("click",r=>{r.target===e&&(e.style.display="none",n.reset())}),n.addEventListener("submit",async r=>{r.preventDefault();const a=n.querySelector('button[type="submit"]');a.disabled=!0,a.textContent="Enviando...";try{const{data:{user:s}}=await u.auth.getUser();if(!s){i("Você precisa estar logado para enviar uma proposta",3e3,0),a.disabled=!1,a.textContent="Enviar Proposta";return}const f=new URLSearchParams(window.location.search).get("id");if(!f){i("ID do anúncio não encontrado",3e3,0),a.disabled=!1,a.textContent="Enviar Proposta";return}const{data:g}=await u.from("anuncios").select("user_id, status").eq("id",f).single();if(!g){i("Anúncio não encontrado",3e3,0),a.disabled=!1,a.textContent="Enviar Proposta";return}if(g.status==="FECHADO"){i("Este anúncio já está fechado e não aceita mais propostas.",3e3,0),e.style.display="none",a.disabled=!1,a.textContent="Enviar Proposta";return}const y=document.getElementById("imagem");let p=null;if(y.files&&y.files[0]&&(p=await U(y.files[0]),!p)){i("Erro ao fazer upload da imagem. Tente novamente.",3e3,0),a.disabled=!1,a.textContent="Enviar Proposta";return}const b={anuncio_id:f,interessado_id:s.id,anunciante_id:g.user_id,mensagem:document.getElementById("mensagem").value,valor_oferecido:parseFloat(document.getElementById("valor_oferecido").value),imagens:p?[p]:void 0};await $(b)?(i("Proposta enviada com sucesso!",3e3,1),e.style.display="none",n.reset()):i("Erro ao enviar proposta. Tente novamente.",3e3,0)}catch(s){console.error("Erro ao processar proposta:",s),i("Erro ao enviar proposta. Tente novamente.",3e3,0)}finally{a.disabled=!1,a.textContent="Enviar Proposta"}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",I):I();
